# 独立邮件板块 - 需求说明

> 本模块为独立服务，与主项目（mathstudy）无代码/数据库耦合，仅通过 HTTP 接口对接。

---

## 1. 定位与边界

- **定位**：为平台提供「发邮件」能力，包括联系表单转发、忘记密码结果通知。
- **边界**：
  - 不依赖主项目数据库、用户体系、权限系统。
  - 不提供收邮件、邮件列表、用户邮箱管理等功能。
  - 主项目负责：鉴权、限流、业务逻辑；本模块只负责：按请求内容发送邮件。

---

## 2. 功能要求

### 2.1 联系表单

- **触发**：主项目在用户提交「联系/留言」表单后，调用本模块。
- **输入**：发件人姓名、邮箱、主题、正文。
- **行为**：向**管理员/指定邮箱**发送一封邮件，内容包含上述信息；`Reply-To` 设为用户邮箱，便于管理员直接回复。
- **可选**：支持配置管理员邮箱（如环境变量 `CONTACT_TO_EMAIL`）。

### 2.2 忘记密码 - 审批通过

- **触发**：主项目在管理员通过某次「忘记密码」申请后调用本模块。
- **输入**：用户邮箱、用户名、临时密码、登录页链接。
- **行为**：向**该用户邮箱**发送一封邮件，说明密码已重置、临时密码、建议登录后修改密码及登录链接。



## 3. 接口要求

### 3.1 健康检查

- **GET /health**
- **响应**：`200`，体如 `{"status": "ok"}`，用于主项目或运维检查服务是否存活。

### 3.2 通用发信（按模板）

- **POST /send**
- **请求体**（JSON）：
  - `to_email`（必填）：收件人邮箱
  - `subject`（必填）：邮件主题
  - `template`（必填）：模板标识，如 `contact`、`password_reset_approved`、`password_reset_rejected`
  - `context`（必填，可空对象）：模板变量，如 `username`、`temp_password`、`login_url`、`reason`、`name`、`email`、`message` 等
- **响应**：成功 `200` + `{"sent": true, "message": "..."}`；失败可返回 `4xx/5xx` 及错误信息。

### 3.3 联系表单（便捷接口，可选）

- **POST /contact**
- **请求体**（JSON）：`name`、`email`、`subject`、`message`
- **行为**：等价于用 `contact` 模板向配置的管理员邮箱发信，并设置 `Reply-To` 为 `email`。

---

## 4. 非功能要求

| 项     | 要求说明 |
|--------|----------|
| **独立部署** | 单独进程/容器，可独立扩缩容，不依赖主项目代码库与数据库。 |
| **配置外置** | SMTP 服务器、端口、认证、发件人、管理员邮箱等均通过环境变量或配置文件提供，不写死在代码中。 |
| **可观测** | 提供 `/health`；关键发送失败建议打日志，便于排查。 |
| **安全** | 不在 URL、日志中明文暴露密码等敏感信息；若对外暴露，可支持 API Key 等简单鉴权（与主项目约定）。 |
| **编码** | 邮件主题、正文支持 UTF-8（中文等）。 |

---

## 5. 与主项目的对接约定

- 主项目通过配置 **邮件服务根地址**（如 `EMAIL_SERVICE_URL`）调用本模块。
- 主项目在以下时机发起调用：
  - 用户提交联系表单 → `POST /contact` 或 `POST /send`（template=contact）
  - 管理员通过忘记密码申请 → `POST /send`（template=password_reset_approved）
  - 管理员拒绝忘记密码申请（若实现）→ `POST /send`（template=password_reset_rejected）
- 主项目负责调用方的鉴权与限流；本模块不校验主项目用户身份，仅按请求参数发信。

---

## 6. 验收要点

- [ ] 联系表单：主项目传入 name/email/subject/message 后，管理员邮箱收到邮件且可回复到用户。
- [ ] 忘记密码通过：主项目传入 to_email、username、temp_password、login_url 后，用户邮箱收到「密码已重置」邮件。
- [ ] 忘记密码拒绝（若实现）：用户收到「申请未通过」邮件。
- [ ] `/health` 返回 200，便于健康检查。
- [ ] 发信配置全部来自环境变量或配置文件，无硬编码敏感信息。